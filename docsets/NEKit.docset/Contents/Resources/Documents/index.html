<!DOCTYPE html>
<html lang="en">
  <head>
    <title>NEKit  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="NEKit  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">NEKit Docs</a> (40% documented)</p>
        <p class="header-right"><a href="https://github.com/zhuhaow/NEKit"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">NEKit Reference</a>
        <img id="carat" src="img/carat.png" />
        NEKit  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Proxy Server.html">Proxy Server</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/ProxyServer.html">ProxyServer</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/GCDProxyServer.html">GCDProxyServer</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/GCDSOCKS5ProxyServer.html">GCDSOCKS5ProxyServer</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Raw Socket.html">Raw Socket</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/RawTCPSocketProtocol.html">RawTCPSocketProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RawTCPSocketDelegate.html">RawTCPSocketDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/GCDTCPSocket.html">GCDTCPSocket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/NWTCPSocket.html">NWTCPSocket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/TUNTCPSocket.html">TUNTCPSocket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/RawSocketFactory.html">RawSocketFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SocketBaseType.html">SocketBaseType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SocketTag.html">SocketTag</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SocketTag/HTTP.html">– HTTP</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SocketTag/SOCKS5.html">– SOCKS5</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/NWUDPSocket.html">NWUDPSocket</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/NWUDPSocketDelegate.html">NWUDPSocketDelegate</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Socket.html">Socket</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/SocketProtocol.html">SocketProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SocketDelegate.html">SocketDelegate</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Proxy Socket.html">Proxy Socket</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/ProxySocket.html">ProxySocket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DirectProxySocket.html">DirectProxySocket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SOCKS5ProxySocket.html">SOCKS5ProxySocket</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Adapter Socket.html">Adapter Socket</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/AdapterSocket.html">AdapterSocket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DirectAdapter.html">DirectAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/HTTPAdapter.html">HTTPAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/HTTPAdapter/ReadTag.html">– ReadTag</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/HTTPAdapter/WriteTag.html">– WriteTag</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ShadowsocksAdapter.html">ShadowsocksAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ShadowsocksAdapter/EncryptMethod.html">– EncryptMethod</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ShadowsocksAdapter/ShadowsocksTag.html">– ShadowsocksTag</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SpeedAdapter.html">SpeedAdapter</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Adapter Socket Factory.html">Adapter Socket Factory</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/AdapterFactoryManager.html">AdapterFactoryManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ServerAdapterFactory.html">ServerAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/AuthenticationAdapterFactory.html">AuthenticationAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Adapter Socket Factory.html#/s:C5NEKit20DirectAdapterFactory">DirectAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ShadowsocksAdapterFactory.html">ShadowsocksAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/HTTPAdapterFactory.html">HTTPAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SecureHTTPAdapterFactory.html">SecureHTTPAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SpeedAdapterFactory.html">SpeedAdapterFactory</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Rule.html">Rule</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Rule.html">Rule</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/AllRule.html">AllRule</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DirectRule.html">DirectRule</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/CountryRule.html">CountryRule</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ListRule.html">ListRule</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DNSSessionMatchType.html">DNSSessionMatchType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DNSSessionMatchResult.html">DNSSessionMatchResult</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="IP stack.html">IP stack</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/TUNInterface.html">TUNInterface</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IPStackProtocol.html">IPStackProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/TCPStack.html">TCPStack</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DNSServer.html">DNSServer</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Utilities.html">Utilities</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/BinaryDataScanner.html">BinaryDataScanner</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Atomic.html">Atomic</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/StreamScanner.html">StreamScanner</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Checksum.html">Checksum</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Classes.html">Other Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/AdapterFactory.html">AdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Box.html">Box</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Configuration.html">Configuration</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConnectRequest.html">ConnectRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Other Classes.html#/s:C5NEKit15ConnectResponse">ConnectResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Cryptor.html">Cryptor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Cryptor/Operation.html">– Operation</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Cryptor/Algorithm.html">– Algorithm</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Cryptor/Mode.html">– Mode</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DNSMessage.html">DNSMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DNSNameConverter.html">DNSNameConverter</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DNSQuery.html">DNSQuery</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DNSResource.html">DNSResource</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DNSSession.html">DNSSession</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/GeoIP.html">GeoIP</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IPPacket.html">IPPacket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IPv4Address.html">IPv4Address</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IPv4Pool.html">IPv4Pool</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Port.html">Port</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/RuleManager.html">RuleManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SecureHTTPAdapter.html">SecureHTTPAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Tunnel.html">Tunnel</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/UDPDNSResolver.html">UDPDNSResolver</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/UDPDirectStack.html">UDPDirectStack</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/UDPProtocolParser.html">UDPProtocolParser</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Enums.html">Other Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/DNSClass.html">DNSClass</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DNSMessageType.html">DNSMessageType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DNSReturnStatus.html">DNSReturnStatus</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DNSType.html">DNSType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IPVersion.html">IPVersion</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SocketStatus.html">SocketStatus</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/TransportProtocol.html">TransportProtocol</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Extensions.html">Other Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/UInt8.html">UInt8</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Functions.html">Other Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Other Functions.html#/s:ZF5NEKitoi2eeFTCS_11IPv4AddressS0__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Other Functions.html#/s:ZF5NEKitoi2eeFTCS_4PortS0__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Other Functions.html#/s:ZF5NEKitoi2eeFTVS_11ConnectInfoS0__Sb">==(_:_:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Protocols.html">Other Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/BinaryReadable.html">BinaryReadable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/DNSResolverDelegate.html">DNSResolverDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/DNSResolverProtocol.html">DNSResolverProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IPAddress.html">IPAddress</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/TransportProtocolParserProtocol.html">TransportProtocolParserProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/TunnelDelegate.html">TunnelDelegate</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Structs.html">Other Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/AdapterFactoryParser.html">AdapterFactoryParser</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Authentication.html">Authentication</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ConnectInfo.html">ConnectInfo</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Opt.html">Opt</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RuleParser.html">RuleParser</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ShadowsocksEncryptHelper.html">ShadowsocksEncryptHelper</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Utils.html">Utils</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Utils/HTTPData.html">– HTTPData</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Utils/DNS.html">– DNS</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Utils/IP.html">– IP</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Utils/GeoIPLookup.html">– GeoIPLookup</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Utils/Crypto.html">– Crypto</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <a href='#nekit' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='nekit'>NEKit</h1>

<p><a href="https://travis-ci.org/zhuhaow/NEKit"><img src="https://travis-ci.org/zhuhaow/NEKit.svg?branch=master" alt="Build Status"></a></p>

<p>A toolkit for Network Extension Framework.</p>

<p>NEKit is the successor of <a href="https://github.com/zhuhaow/soca-ios">Soca</a>. The design goal of NEKit is to provide everything needed in building a Network Extension app with <code>NETunnelProvider</code> while keep the framework as non-opinionated as possible.</p>

<p><strong>NEKit does not depend on Network Extension framework. You can use NEKit without Network Extension entitlement to build a rule based proxy in a few lines.</strong></p>

<p>Currently, NEKit supports:</p>

<ul>
<li>Forward requests through different proxies based on remote host location, remote host domain or the connection speed of proxies.</li>
<li>Integrated tun2socks framework to reassemble TCP packets into TCP flows.</li>
<li>A DNS server that rewrites request and response.</li>
<li>Some tools to build IP packets.</li>
<li>&hellip;</li>
</ul>

<p>Check document <a href="https://zhuhaow.github.io/NEKit">here</a>, which is not finished yet.</p>

<p>Also, you may be more interested in <a href="https://github.com/shadowsocks/Potatso-iOS">Potatso</a> if you just need a working app with GUI supporting shadowsocks.</p>
<a href='#principle' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='principle'>Principle</h2>

<p>NEKit tries to be as flexible and non-opionated as possible. </p>

<p>However, it is not always as modular as you may think if you want to reproduce transport layer from network layer.</p>

<p>NEKit follows one fundamental principle to keep the best network performance: The host connecting to target server resolves the domain. </p>

<p>This should not be a problem if the applications on your device connect to the local proxy server directly, where we can get the request domain information then send that to remote proxy server if needed.</p>

<p>But consider that if an application tries to make a socket connection by itself (e.g., Twitter.app), which generally consists of two steps: </p>

<ol>
<li>Make a DNS lookup to find the IP address of the target server.</li>
<li>Connect to the remote server by socket API provided by the system.</li>
</ol>

<p>We can read only two independent things from the TUN interface, a UDP packet containing the DNS lookup request and a TCP flow consisting of a serial of TCP packets. So there is no way we can know the initial request domain for the TCP flow. And since there may be multiple domains served on the same host, we can not get the origin domain by saving the DNS response and looking that up reversely later.</p>

<p>The only solution is to create a fake IP pool and assign each requested domain with a unique fake IP so we can look that up reversely. Every connection later need to look that up from the DNS server; this is the only non-modular part of NEKit which is already encapsulated in <code>ConnectRequest</code>.</p>
<a href='#usage' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='usage'>Usage</h2>
<a href='#add-it-to-you-project' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='add-it-to-you-project'>Add it to you project</h3>

<p>I recommend adding this project to your project, which is easier to debug. </p>

<p>However, you can still use it with Carthage (you&rsquo;ll need Carthage anyway since NEKit uses Carthage) by adding
<code>
github &quot;zhuhaow/NEKit&quot;
</code>
to you <code>Cartfile</code>.</p>
<a href='#overview' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='overview'>Overview</h3>

<p>NEKit basically consists of two parts, a proxy server forwarding socket data based on user defined rules and an IP stack reassembling IP packets back to TCP flow as a socket.</p>
<a href='#rule-manager' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='rule-manager'>Rule manager</h3>

<p>Before starting any proxy server, we need to define rules.</p>

<p>Each rule consists of two parts, one defining what kinding of request matches this rule and the other defining what adapter to use. An adapter represents the abstraction of a socket connection to a remote proxy server (or remote host). We use <code>AdapterFactory</code> to build adapters.</p>
<pre class="highlight swift"><code><span class="c1">// Define remote adapter first</span>
<span class="k">let</span> <span class="nv">directAdapterFactory</span> <span class="o">=</span> <span class="kt">DirectAdapterFactory</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">httpAdapterFactory</span> <span class="o">=</span> <span class="kt">HTTPAdapterFactory</span><span class="p">(</span><span class="nv">serverHost</span><span class="p">:</span> <span class="s">"remote.http.proxy"</span><span class="p">,</span> <span class="nv">serverPort</span><span class="p">:</span> <span class="mi">3128</span><span class="p">,</span> <span class="nv">auth</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">ssAdapterFactory</span> <span class="o">=</span> <span class="kt">ShadowsocksAdapterFactory</span><span class="p">(</span><span class="nv">serverHost</span><span class="p">:</span> <span class="s">"remote.ss.proxy"</span><span class="p">,</span> <span class="nv">serverPort</span><span class="p">:</span> <span class="mi">7077</span><span class="p">,</span> <span class="nv">encryptMethod</span><span class="p">:</span> <span class="s">"AES-256-CFB"</span><span class="p">,</span> <span class="nv">password</span><span class="p">:</span> <span class="s">"1234567890"</span><span class="p">)</span>

<span class="c1">// Then create rules</span>
<span class="k">let</span> <span class="nv">chinaRule</span> <span class="o">=</span> <span class="kt">CountryRule</span><span class="p">(</span><span class="nv">countryCode</span><span class="p">:</span> <span class="s">"CN"</span><span class="p">,</span> <span class="nv">match</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">adapterFactory</span><span class="p">:</span> <span class="n">directAdapterFactory</span><span class="p">)</span>
<span class="c1">// `urls` are regular expressions</span>
<span class="k">let</span> <span class="nv">listRule</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">ListRule</span><span class="p">(</span><span class="nv">adapterFactory</span><span class="p">:</span> <span class="n">ssAdapterFactory</span><span class="p">,</span> <span class="nv">urls</span><span class="p">:</span> <span class="p">[</span><span class="s">"some</span><span class="se">\\</span><span class="s">.site</span><span class="se">\\</span><span class="s">.does</span><span class="se">\\</span><span class="s">.not</span><span class="se">\\</span><span class="s">.exists"</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">allRule</span> <span class="o">=</span> <span class="kt">AllRule</span><span class="p">(</span><span class="nv">adapterFactory</span><span class="p">:</span> <span class="n">httpAdapterFactory</span><span class="p">)</span>

<span class="c1">// Create rule manager, rules will be matched in order.</span>
<span class="k">let</span> <span class="nv">manager</span> <span class="o">=</span> <span class="kt">RuleManager</span><span class="p">(</span><span class="nv">fromRules</span><span class="p">:</span> <span class="p">[</span><span class="n">listRule</span><span class="p">,</span> <span class="n">chinaRule</span><span class="p">,</span> <span class="n">allRule</span><span class="p">],</span> <span class="nv">appendDirect</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>

<span class="c1">// Set this manager as the active manager</span>
<span class="kt">RuleManager</span><span class="o">.</span><span class="n">currentManager</span> <span class="o">=</span> <span class="n">ruleManager</span>
</code></pre>

<p>There is also <code>Parser</code> to load rules from a Yaml config file. But that is not recommended.</p>
<a href='#proxy-server' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='proxy-server'>Proxy server</h3>

<p>Now we can start a proxy server locally.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">server</span> <span class="o">=</span> <span class="kt">GCDSOCKS5ProxyServer</span><span class="p">(</span><span class="nv">address</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"127.0.0.1"</span><span class="p">),</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Port</span><span class="p">(</span><span class="nv">port</span><span class="p">:</span> <span class="mi">9090</span><span class="p">)</span>
<span class="c1">// There can be multiple proxies running at the same time, but one of them must be set as the `mainProxy` to handle TCP socket from IP stack.</span>
<span class="kt">ProxyServer</span><span class="o">.</span><span class="n">mainProxy</span> <span class="o">=</span> <span class="n">server</span>
<span class="k">try!</span> <span class="kt">ProxyServer</span><span class="o">.</span><span class="n">mainProxy</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre>

<p>Now there is a SOCKS5 proxy server running on <code>127.0.0.1:9090</code> which will forward requests based on rules defined in <code>RuleManager.currentManager</code>.</p>

<p>If you do not want to handle IP packets, then that&rsquo;s it, just set the proxy to <code>127.0.0.1:9090</code> in System Preferences and you are good to go.</p>

<p>If you want to read on, you will have to request Network Extention entitlement from Apple.</p>
<a href='#ip-stack' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='ip-stack'>IP stack</h3>

<p>Assuming you already set up a working extension with correct routing configurations (Google how, this is not trivial).</p>

<p>In </p>
<pre class="highlight swift"><code><span class="nf">startTunnelWithOptions</span><span class="p">(</span><span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">NSObject</span><span class="p">]?,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="p">(</span><span class="kt">NSError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
</code></pre>

<p>set <code>RuleManager</code> and start proxy server(s) and then create an instance representing the TUN interface by</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">stack</span> <span class="o">=</span> <span class="kt">TUNInterface</span><span class="p">(</span><span class="nv">packetFlow</span><span class="p">:</span> <span class="n">packetFlow</span><span class="p">)</span>
</code></pre>

<p>We also have to set</p>
<pre class="highlight swift"><code><span class="kt">RawSocketFactory</span><span class="o">.</span><span class="kt">TunnelProvider</span> <span class="o">=</span> <span class="k">self</span>
</code></pre>

<p>to create socket to connect to remote servers with <code>NETunnelProvider</code>.</p>

<p>Then we need to register ip stacks implementing <code>IPStackProtocol</code> to process IP packets.</p>

<p>NEKit provides several stacks.</p>
<a href='#tcpstack' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='tcpstack'>TCPStack</h4>

<p><code>TCPStack</code> process TCP packets and reassembles them back into TCP flows then send them to the <code>ProxyServer.mainProxy</code> server (Do not worry about the type of the proxy server, they will be handled as direct connection).</p>
<a href='#dnsserver' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='dnsserver'>DNSServer</h4>

<p>DNS server is implemented as an IP stack processing UDP packets send to it.</p>

<p>First create an DNS server with a fake IP pool. (You should use fake IP, but you can disable it if you want to by set it to nil.)</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">fakeIPPool</span> <span class="o">=</span> <span class="kt">IPv4Pool</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"172.169.1.0"</span><span class="p">),</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"172.169.255.0"</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">dnsServer</span> <span class="o">=</span> <span class="kt">DNSServer</span><span class="p">(</span><span class="nv">address</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"172.169.0.1"</span><span class="p">),</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Port</span><span class="p">(</span><span class="nv">port</span><span class="p">:</span> <span class="mi">53</span><span class="p">),</span> <span class="nv">fakeIPPool</span><span class="p">:</span> <span class="n">fakeIPPool</span><span class="p">)</span>
</code></pre>

<p>Then we have to define how to resolve the DNS requests, NEKit provides the most trivial one which sends the request to remote DNS server directly with UDP protocol, you can do anything you want by implementing <code>DNSResolverProtocol</code>.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">resolver</span> <span class="o">=</span> <span class="kt">UDPDNSResolver</span><span class="p">(</span><span class="nv">address</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"114.114.114.114"</span><span class="p">),</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Port</span><span class="p">(</span><span class="nv">port</span><span class="p">:</span> <span class="mi">53</span><span class="p">))</span>
<span class="n">dnsServer</span><span class="o">.</span><span class="nf">registerResolver</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span>
</code></pre>

<p>It is very important to set </p>
<pre class="highlight swift"><code><span class="kt">DNSServer</span><span class="o">.</span><span class="n">currentServer</span> <span class="o">=</span> <span class="n">dnsServer</span>
</code></pre>

<p>so we can look up the fake IP reversely.</p>
<a href='#udpdirectstack' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='udpdirectstack'>UDPDirectStack</h4>

<p><code>UDPDirectStack</code> sends and reads UDP packets to and from remote server directly.</p>

<p>You can register these stack to TUN interface by</p>
<pre class="highlight swift"><code><span class="n">interface</span><span class="o">.</span><span class="nf">registerStack</span><span class="p">(</span><span class="n">dnsServer</span><span class="p">)</span>
<span class="c1">// Note this sends out every UDP packets directly so this must comes after any other stack that processes UDP packets.</span>
<span class="n">interface</span><span class="o">.</span><span class="nf">registerStack</span><span class="p">(</span><span class="kt">UDPDirectStack</span><span class="p">())</span>
<span class="n">interface</span><span class="o">.</span><span class="nf">registerStack</span><span class="p">(</span><span class="kt">TCPStack</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre>

<p>When everything is set up, you should start processing packets by calling <code>interface.start()</code> in the completion handler of <code>setTunnelNetworkSettings</code>.</p>
<a href='#dive-in' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='dive-in'>Dive in</h2>
<a href='#framework-overview' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='framework-overview'>Framework overview</h3>

<p>The structure of the proxy server is given as follows:</p>
<pre class="highlight plaintext"><code>┌──────────────────────────────────────────────────┐
│                                                  │
│                   ProxyServer                    │
│                                                  │
├──────┬───┬──────┬───┬──────┬───┬──────┬───┬──────┤
│Tunnel│   │Tunnel│   │Tunnel│   │Tunnel│   │Tunnel│
└──────┘   └──────┘   └───▲──┘   └──────┘   └──────┘
                         ╱ ╲                        
                ╱───────╱   ╲─────╲                 
               ╱                   ╲                
     ┌────────▼────────┐   ┌────────▼────────┐      
     │   ProxySocket   │   │  AdapterSocket  │      
     └────────▲────────┘   └────────▲────────┘      
              │                     │               
              │                     │               
     ┌────────▼────────┐   ┌────────▼────────┐      
     │RawSocketProtocol│   │RawSocketProtocol│      
     └────────▲────────┘   └────────▲────────┘      
              │                     │               
              │                     │               
       ╔══════▼═══════╗     ╔═══════▼══════╗        
       ║    LOCAL     ║     ║    REMOTE    ║        
       ╚══════════════╝     ╚══════════════╝        
</code></pre>

<p>When a new socket is accepted from the listening socket of the proxy server, it is wrapped in some implemention of <code>RawSocketProtocol</code> as a raw socket which just reads and writes data. </p>

<p>Then it is wrapped in a subclass of <code>ProxySocket</code> which encapsulates the proxy logic. Currently, only <code>DirectProxySocket</code> (for sockets from <code>TCPStack</code>) and <code>SOCKS5ProxySocket</code> (for SOCKS5 proxy server) are implemented. If there is ever need for a HTTP proxy (Do you really need that? It&rsquo;s complicated, error-prone and full of edge cases which probably will never be implemented correctly. The real world does love non-standard implemention of HTTP.), then a <code>HTTPProxySocket</code> should be implemented and a proxy server called <code>GCDHTTPProxyServer</code> subclassing <code>GCDProxyServer</code> should wrap every accepted <code>RawSocketProtocol</code> in  <code>HTTPProxySocket</code>.</p>

<p>The <code>TCPStack</code> wraps the reassembled TCP flow (<code>TUNTCPSocket</code>) in <code>DirectProxySocket</code> then send it to the <code>mainProxy</code> server.</p>

<p>Similarly, <code>AdapterSocket</code> encapsulated the logic of how to connect to remote and process the data flow.</p>

<p>Pretty much everything of NEKit follows the <a href="https://en.wikipedia.org/wiki/Delegation_pattern">delegation pattern</a>. If you are not familiar with that, you should learn it first, probabaly by learning how to use <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a> (note that the sockets in NEKit are <strong>not</strong> thread-safe which is different from GCDAsyncSocket).</p>
<a href='#the-lifetime-of-a-code-tunnel-code' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='the-lifetime-of-a-code-tunnel-code'>The lifetime of a <code>Tunnel</code></h3>

<p>When a <code>RawSocketProtocol</code> socket is accepted or created by <code>TCPStack</code>, it is wrapped in a <code>ProxySocket</code> then in a <code>Tunnel</code>. The <code>Tunnel</code> will call <code>proxySocket.openSocket()</code> to let the proxy socket start process data. </p>

<p>When the <code>ProxySocket</code> read enough data to build a <code>ConnectRequest</code>, it calls <code>func didReceiveRequest(request: ConnectRequest, from: ProxySocket)</code> of the <code>delegate</code> (which should be the <code>Tunnel</code>). </p>

<p>The <code>Tunnel</code> then matches this request in <code>RuleManager</code> to get the corresponding <code>AdapterFactory</code>. Then <code>func openSocketWithRequest(request: ConnectRequest)</code> of the produced <code>AdapterSocket</code> is called to connect to remote server.</p>

<p>The <code>AdapterSocket</code> calls <code>func didConnect(adapterSocket: AdapterSocket, withResponse response: ConnectResponse)</code> of the <code>Tunnel</code> to let the <code>ProxySocket</code> has a chance to respond to remote response. (This is ignored as of now.) </p>

<p>Finally, when the <code>ProxySocket</code> and <code>AdapterSocket</code> are ready to forward data, they should call <code>func readyToForward(socket: SocketProtocol)</code> of the <code>Tunnel</code> to let it know. When both sides are ready, the tunnel will read from both sides and then send the received data to the other side intact.</p>

<p>When any side of the tunnel is disconnected, the <code>func didDisconnect(socket: SocketProtocol)</code> is called then both sides are closed actively. The <code>Tunnel</code> will be released when both sides disconnect successfully.</p>
<a href='#todo' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='todo'>TODO</h2>

<ul>
<li>[ ] More encryption algrithm in Shadowsocks</li>
<li>[ ] Documents.</li>
<li>[ ] IPv6 support.</li>
<li>[ ] tun2socks stability improvement.</li>
</ul>
<a href='#license' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='license'>License</h2>

<p>Copyright &copy; 2016, Zhuhao Wang
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ul>
<li><p>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</p></li>
<li><p>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</p></li>
<li><p>Neither the name of NEKit nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.</p></li>
</ul>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS <q>AS IS</q> AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2016 <a class="link" href="" target="_blank" rel="external">Zhuhao Wang</a>. All rights reserved. (Last updated: 2016-07-01)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.0</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
